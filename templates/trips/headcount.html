{% extends "base.html" %}
{% block title %}Headcount · TripTrack{% endblock %}

{% block head %}
{# NOTE: Styles for custom form inputs to match our theme #}
<style>
  #id_q, #id_order, #id_only {
    display: block;
    width: 100%;
    border-radius: 0.5rem;
    padding: 0.5rem 0.875rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
    transition: all .2s ease-in-out;
  }
  #id_order, #id_only {
    padding-right: 2.5rem;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
  }
  .dark #id_order, .dark #id_only {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  }

  .light #id_q, .light #id_order, .light #id_only { background-color: #f8fafc; border: 1px solid #cbd5e1; color: #0f172a; }
  .light #id_q:focus, .light #id_order:focus, .light #id_only:focus { --tw-ring-color: #14b8a6; border-color: #14b8a6; box-shadow: 0 0 0 2px var(--tw-ring-color); }
  .dark #id_q, .dark #id_order, .dark #id_only { background-color: #1e293b; border: 1px solid #475569; color: #f1f5f9; }
  .dark #id_q:focus, .dark #id_order:focus, .dark #id_only:focus { --tw-ring-color: #2dd4bf; border-color: #2dd4bf; box-shadow: 0 0 0 2px var(--tw-ring-color); }
  
  .custom-checkbox {
    height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; accent-color: #0d9488;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">

  <header class="space-y-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-heading font-bold text-slate-900 dark:text-slate-100">Headcount — {{ trip.name }}</h1>
        <p class="text-slate-600 dark:text-slate-400">
          Pickup: {{ trip.pickup_point }} · Meetup: {{ trip.meetup_time|time:"g:i A" }}
        </p>
      </div>
      <div class="flex-shrink-0 grid grid-cols-3 gap-3 text-center bg-slate-100 dark:bg-slate-800/50 p-2 rounded-xl">
        <div><div class="text-xs text-slate-500 dark:text-slate-400">Total</div><b class="text-slate-900 dark:text-white">{{ totals_all.total }}</b></div>
        <div><div class="text-xs text-slate-500 dark:text-slate-400">Outbound</div><b class="text-slate-900 dark:text-white">{{ totals_all.outbound }}</b></div>
        <div><div class="text-xs text-slate-500 dark:text-slate-400">Return</div><b class="text-slate-900 dark:text-white">{{ totals_all.return }}</b></div>
      </div>
    </div>
    <div class="inline-flex items-center gap-1 bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
      <a href="{% url 'trips:headcount' %}?mode=out{% if q %}&q={{ q|urlencode }}{% endif %}{% if order %}&order={{ order }}{% endif %}{% if only %}&only={{ only }}{% endif %}"
        class="px-4 py-1.5 rounded-lg text-sm font-semibold tween {% if mode == 'out' %}bg-brand-500 text-white shadow-md{% else %}text-slate-600 dark:text-slate-300 hover:bg-white/60 dark:hover:bg-slate-700/50{% endif %}">
        Outbound
      </a>
      <a href="{% url 'trips:headcount' %}?mode=ret{% if q %}&q={{ q|urlencode }}{% endif %}{% if order %}&order={{ order }}{% endif %}{% if only %}&only={{ only }}{% endif %}"
        class="px-4 py-1.5 rounded-lg text-sm font-semibold tween {% if mode == 'ret' %}bg-brand-500 text-white shadow-md{% else %}text-slate-600 dark:text-slate-300 hover:bg-white/60 dark:hover:bg-slate-700/50{% endif %}">
        Return
      </a>
    </div>
  </header>
  
  <section class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50 p-4 shadow-xl dark:shadow-2xl">
    <form method="get" class="flex flex-wrap items-end gap-4">
      <input type="hidden" name="mode" value="{{ mode }}">
      <div class="w-full sm:w-auto sm:flex-1 sm:min-w-[200px]">
        <label for="id_q" class="text-xs font-medium text-slate-600 dark:text-slate-400">Search name / phone</label>
        <input id="id_q" type="text" name="q" value="{{ q }}" placeholder="e.g., Riya / 98765" />
      </div>
      <div class="w-full sm:w-auto">
        <label for="id_order" class="text-xs font-medium text-slate-600 dark:text-slate-400">Sort by</label>
        <select id="id_order" name="order">
          <option value="name_asc" {% if order == "name_asc" %}selected{% endif %}>Name A → Z</option>
          <option value="name_desc" {% if order == "name_desc" %}selected{% endif %}>Name Z → A</option>
        </select>
      </div>
      <div class="w-full sm:w-auto">
        <label for="id_only" class="text-xs font-medium text-slate-600 dark:text-slate-400">Filter</label>
        <select id="id_only" name="only">
          <option value="" {% if only == "" %}selected{% endif %}>Show All</option>
          <option value="unchecked" {% if only == "unchecked" %}selected{% endif %}>Only Unchecked</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <button class="px-5 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-white dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-200 text-sm font-semibold tween" type="submit">Apply</button>
        <a href="{% url 'trips:headcount' %}?mode={{ mode }}" class="px-5 py-2 rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 text-sm font-semibold tween">Reset</a>
      </div>
      <div class="w-full sm:w-auto sm:ml-auto text-sm text-slate-600 dark:text-slate-400 text-right">
        Showing <b>{{ totals_shown.total }}</b> · Checked <b>{{ totals_shown.checked }}</b>
      </div>
    </form>
  </section>

  <form method="post" class="space-y-6">
    {% csrf_token %}
    <input type="hidden" name="mode" value="{{ mode }}" />
     <input type="hidden" name="q" value="{{ q }}" />
    <input type="hidden" name="order" value="{{ order }}" />
    <input type="hidden" name="only" value="{{ only }}" />
    <section class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50 p-4 md:p-6 shadow-xl dark:shadow-2xl">
      <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4">
        {% if mode == 'out' %}Outbound Boarding List{% else %}Return Boarding List{% endif %}
      </h2>

      <div class="space-y-3 md:hidden">
        {% for r in regs %}
          {# NOTE: Entire card is now a clickable label for better mobile UX #}
          <label for="{{ mode }}-{{ r.id }}"
                 class="block rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 p-4 peer-checked:bg-brand-50 peer-checked:border-brand-300 dark:peer-checked:bg-brand-900/40 dark:peer-checked:border-brand-700 tween cursor-pointer">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="font-medium text-slate-900 dark:text-slate-100">{{ r.full_name }}</div>
                <div class="text-sm text-slate-500 dark:text-slate-400">
                  {% if r.phone|slice:":3" == "+91" %}{{ r.phone|slice:"3:" }}{% else %}{{ r.phone }}{% endif %}
                </div>
              </div>
              <input type="hidden" name="{{ mode }}-{{ r.id }}" value="off" />
              <input id="{{ mode }}-{{ r.id }}" type="checkbox" name="{{ mode }}-{{ r.id }}" value="on"
                     {% if mode == 'out' and r.boarded_outbound %}checked{% endif %}
                     {% if mode == 'ret' and r.boarded_return %}checked{% endif %}
                     class="custom-checkbox peer shrink-0">
            </div>
          </label>
        {% empty %}
          <div class="rounded-xl border border-slate-200 dark:border-slate-700 p-5 text-center text-slate-500 dark:text-slate-400">No participants match your search.</div>
        {% endfor %}
      </div>

      <div class="hidden md:block overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-400">
            <tr class="text-left">
              <th class="py-3 px-4 font-semibold">Name</th>
              <th class="py-3 px-4 font-semibold">Phone</th>
              <th class="py-3 px-4 font-semibold text-right">Boarded</th>
            </tr>
          </thead>
          <tbody class="text-slate-800 dark:text-slate-200">
            {% for r in regs %}
            <tr class="border-t border-slate-200 dark:border-slate-700 hover:bg-slate-50/70 dark:hover:bg-slate-700/50">
              <td class="py-3 px-4">{{ r.full_name }}</td>
              <td class="py-3 px-4">
                {% if r.phone|slice:":3" == "+91" %}{{ r.phone|slice:"3:" }}{% else %}{{ r.phone }}{% endif %}
              </td>
              <td class="py-3 px-4 text-right">
                <input type="hidden" name="{{ mode }}-{{ r.id }}" value="off" />
                <input id="desktop-{{ mode }}-{{ r.id }}" type="checkbox" name="{{ mode }}-{{ r.id }}" value="on"
                       {% if mode == 'out' and r.boarded_outbound %}checked{% endif %}
                       {% if mode == 'ret' and r.boarded_return %}checked{% endif %}
                       class="custom-checkbox">
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="py-4 px-4 text-center text-slate-500 dark:text-slate-400">No participants match your search.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <p class="text-sm text-slate-500 dark:text-slate-400">
        Only the <b>{{ totals_shown.total }}</b> participants shown above will be updated on save.
      </p>
      <button type="submit" class="w-full sm:w-auto px-6 py-3 rounded-xl bg-brand-500 hover:bg-brand-600 text-white font-semibold shadow-button hover:shadow-lg tween">
        Save Changes
      </button>
    </div>
  </form>
</div>
{% endblock %}