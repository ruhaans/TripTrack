{% extends "base.html" %}
{% block title %}My Trips · TripTrack{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-8">

  {# Optional: gentle verify reminder #}
  {% if request.user.is_authenticated and not request.user.email_verified %}
    <div class="rounded-2xl border bg-yellow-50 text-yellow-900 text-sm p-3">
      Please verify your email to join new trips.
      <a href="{% url 'accounts:resend-verification' %}" class="underline">Resend verification email</a>
    </div>
  {% endif %}

  {# New trip banner (only when there's an active trip the user has NOT joined) #}
  {% if new_trip %}
    <div class="rounded-2xl border border-dashed bg-gray-50 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h2 class="text-sm font-medium">🎉 New trip available: {{ new_trip.name }}</h2>
        <p class="text-xs text-gray-600">
          📅 {{ new_trip.date }} · 🕘 {{ new_trip.meetup_time }} · 📍 {{ new_trip.pickup_point }}
        </p>
      </div>
      <div class="flex items-center gap-2">
        <a href="{% url 'trips:trip-details' %}" class="text-sm underline">View details</a>
        {% if request.user.email_verified %}
          <a href="{% url 'trips:register' %}" class="text-sm inline-flex items-center rounded-lg bg-black text-white px-3 py-1.5 hover:bg-black/90">
            Join this trip
          </a>
        {% else %}
          <a href="{% url 'accounts:resend-verification' %}" class="text-sm inline-flex items-center rounded-lg border px-3 py-1.5 hover:bg-gray-100">
            Verify to join
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {# Upcoming registrations you HAVE joined #}
  <section class="space-y-3">
    <h2 class="text-lg font-semibold">Upcoming</h2>
    {% if upcoming %}
      <div class="space-y-3">
        {% for r in upcoming %}
          <div class="rounded-2xl border bg-white p-5">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="font-semibold">{{ r.trip.name }}</h3>
                  {% if r.status == "paid" %}
                    <span class="text-xs rounded bg-green-100 text-green-700 px-2 py-0.5 border border-green-200">Paid</span>
                  {% elif r.status == "pending" %}
                    <span class="text-xs rounded bg-yellow-100 text-yellow-800 px-2 py-0.5 border border-yellow-200">Pending</span>
                  {% else %}
                    <span class="text-xs rounded bg-gray-200 text-gray-700 px-2 py-0.5">Cancelled</span>
                  {% endif %}
                </div>
                <p class="text-sm text-gray-600 mt-1">
                  📅 {{ r.trip.date }} · 🕘 {{ r.trip.meetup_time }} · 📍 {{ r.trip.pickup_point }}
                </p>
                <ul class="text-sm text-gray-700 mt-2 space-y-1">
                  <li><span class="font-medium">Park:</span> {{ r.get_park_choice_display }}</li>
                  <li><span class="font-medium">Name:</span> {{ r.full_name }}</li>
                  <li><span class="font-medium">Phone:</span> {{ r.phone }}</li>
                  {% if r.imagica_transaction %}
                    <li><span class="font-medium">Ticket ref:</span> {{ r.imagica_transaction }}</li>
                  {% else %}
                    <li class="text-gray-500">Ticket reference will appear after booking.</li>
                  {% endif %}
                </ul>
              </div>
              <div class="text-right text-sm text-gray-600 shrink-0">
                <div><span class="font-medium">Outbound:</span> {% if r.boarded_outbound %}✅{% else %}—{% endif %}</div>
                <div><span class="font-medium">Return:</span> {% if r.boarded_return %}✅{% else %}—{% endif %}</div>
              </div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2 text-sm">
              <a href="{% url 'trips:trip-details' %}" class="underline">Trip details</a>
              {% if r.status == "pending" %}
                <span class="text-gray-500">Payment pending — you’ll be emailed once confirmed.</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm text-gray-600">No upcoming trips yet.</p>
    {% endif %}
  </section>

  {# Past registrations you HAVE joined #}
  <section class="space-y-3">
    <h2 class="text-lg font-semibold">Past trips</h2>
    {% if past %}
      <div class="space-y-3">
        {% for r in past %}
          <div class="rounded-2xl border bg-white p-5">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="font-semibold">{{ r.trip.name }}</h3>
                  {% if r.status == "paid" %}
                    <span class="text-xs rounded bg-green-100 text-green-700 px-2 py-0.5 border border-green-200">Paid</span>
                  {% elif r.status == "pending" %}
                    <span class="text-xs rounded bg-yellow-100 text-yellow-800 px-2 py-0.5 border border-yellow-200">Pending</span>
                  {% else %}
                    <span class="text-xs rounded bg-gray-200 text-gray-700 px-2 py-0.5">Cancelled</span>
                  {% endif %}
                </div>
                <p class="text-sm text-gray-600 mt-1">
                  📅 {{ r.trip.date }} · 🕘 {{ r.trip.meetup_time }} · 📍 {{ r.trip.pickup_point }}
                </p>
                <ul class="text-sm text-gray-700 mt-2 space-y-1">
                  <li><span class="font-medium">Park:</span> {{ r.get_park_choice_display }}</li>
                  <li><span class="font-medium">Name:</span> {{ r.full_name }}</li>
                  <li><span class="font-medium">Phone:</span> {{ r.phone }}</li>
                  {% if r.imagica_transaction %}
                    <li><span class="font-medium">Ticket ref:</span> {{ r.imagica_transaction }}</li>
                  {% endif %}
                </ul>
              </div>
              <div class="text-right text-sm text-gray-600 shrink-0">
                <div><span class="font-medium">Outbound:</span> {% if r.boarded_outbound %}✅{% else %}—{% endif %}</div>
                <div><span class="font-medium">Return:</span> {% if r.boarded_return %}✅{% else %}—{% endif %}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm text-gray-600">No past trips yet.</p>
    {% endif %}
  </section>

</div>
{% endblock %}
